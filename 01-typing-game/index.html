<title>A Typing Game</title>
<style>
  :root {
    color-scheme: light dark;
    --green: #00b755;
    --yellow: #daaf38;
    --red: #ca4754;
    --black: #222;
    --gray: #999;
    }

    body {
      background: var(--black);
      font-family: monospace;
      display: grid;
      justify-content: center;
      padding: 32px;
      margin-top: 32px;
      padding: 16px;
    }

    section{
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 500px;
    }

    time {
      color: var(--yellow);
    }

    input {
      z-index: -999;
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;

    }

    p {
      display: flex;
      flex-wrap: wrap;
      gap: 3px 6px;
      /* color: var(--grey); */
      margin: 0;
    }

    x-letter {
      color: var(--gray);
      position: relative;

      &.active::before {
        content: '|';
        color: var(--yellow);
        font-size: 14px;
        position: absolute;
        left: -68%;
        animation: 1s blink infinite ease-in-out;
      }

      &.active.is-last::before {
        left: 65%;
      }

      &.correct {
        color: var(--green);
      }

      &.incorrect {
        color: var(--red);
      }

    }

    x-word {
      border-bottom: 1.5px solid transparent;
      transition: border-color 0.3s ease-in-out;


      &.marked {
        border-color: var(--red);
      }
    }


    @keyframes blink {
        0%, 25% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
    }
</style>

<body>
  <main>Welcome Typing</main>
  <section id="game">
    <time></time>
    <p></p>
    <input autofocus />
  </section>
</body>

<script>
  const $time = document.querySelector('time');
  const $paragraph = document.querySelector('p');
  const $input = document.querySelector('input');

  const INITIAL_TIME = 30;
  const TEXT = `
  Quiero que inventen ya la vacuna contra el racismo
  Y que el planeta acepte que en el fondo todos somos lo mismo
  Quiero que las municiones se conviertan en pan
  Y que los superhéroes salgan de la serie donde están
  Yo quiero que la avaricia nunca le gane al honor
  Y que la única religión en el mundo se llame amor
  Hay muchas cosas que quisiera
  Pero por los momentos me conformo con rapear hasta que me muera
  `.replace(/\s+/g, ' ').trim();


  let words = []
  let currentTime = INITIAL_TIME;


  initGame();
  initEvents();

  function initGame() {
    $input.value = '';
    words = TEXT.split(" ").slice(0, 25)
    currentTime = INITIAL_TIME;
    $time.textContent = currentTime;

    $paragraph.innerHTML = words.map((word, index) => {
      const letters = word.split('');

      return `<x-word>
        ${letters
        .map(letter => `<x-letter>${letter}</x-letter>`)
        .join('')
        }
      </x-word>
      `
    }).join('')

    const $firstWord = $paragraph.querySelector('x-word')
    $firstWord.classList.add('active');
    $firstWord.querySelector('x-letter').classList.add('active');

    const intervalId = setInterval(() => {
      currentTime--
      $time.textContent = currentTime;

      if (currentTime === 0) {
        clearInterval(intervalId);
        gameOver();
      }
    }, 1000)
  }

  function initEvents() {

    document.addEventListener('keydown', ()=> {
      $input.focus();
    });

    $input.addEventListener('keydown', onKeyDown);
    $input.addEventListener('keyup', onKeyUp);



  }


  function onKeyDown(event){

    const $currentWord = $paragraph.querySelector('x-word.active')
    const $currentLetter = $currentWord.querySelector('x-letter.active')

    const { key } = event;
    if (key === ' ') {
      event.preventDefault();

      const $nextWord = $currentWord.nextElementSibling;
      const $nextLetter = $nextWord.querySelector('x-letter');

      $currentWord.classList.remove('active', 'marked');
      $nextWord.classList.add('active');

      $currentLetter.classList.remove('active');
      $nextLetter.classList.add('active');

      $input.value = '';

      const hasMissedLetters = $currentWord.querySelectorAll('x-letter:not(.correct)').length > 0;

      const classToAdd = hasMissedLetters ? 'marked' : 'correct';
      $currentWord.classList.add(classToAdd);
      return;

    }

    if (key === 'Backspace') {

      const $prevWord = $currentWord.previousElementSibling;
      const $prevLetter = $currentLetter.previousElementSibling;

      if (!$prevWord && !$prevLetter) {
        event.preventDefault();
        return
      }

      const $wordMarked = $paragraph.querySelector('x-word.marked');
      if ($wordMarked && !$prevLetter) {
        event.preventDefault();
        $prevWord.classList.remove('marked');
        $prevWord.classList.add('active');

        const $letterToGo = $prevWord.querySelector('x-letter:last-child');

        $currentLetter.classList.remove('active');
        $letterToGo.classList.add('active');

        $input.value = [
          ...$prevWord.querySelectorAll('x-letter.correct, x-letter.incorrect')
        ].map($el => {
          return $el.classList.contains('correct') ? $el.innerText : '*';
        }).join('');

      }

    }

  }

  function onKeyUp(){
    const $currentWord = $paragraph.querySelector('x-word.active')
    const $currentLetter = $currentWord.querySelector('x-letter.active')

    const currentWord = $currentWord.innerText.trim()
    $input.maxLength = currentWord.length
    console.log({value: $input.value, currentWord});

    const $allLetters = $currentWord.querySelectorAll('x-letter')

    $allLetters.forEach($letter => $letter.classList.remove('correct' , 'incorrect'))

    $input.value.split('').forEach((char, index) => {
      const $letter = $allLetters[index];
      const letterCheck = currentWord[index];

      const isCorrect = char === letterCheck;
      $letter.classList.add(isCorrect ? 'correct' : 'incorrect');
    });

    $currentLetter.classList.remove('active', 'is-last');
    const inputLength = $input.value.length;
    const $nextActiveLetter = $allLetters[inputLength];

    if ($nextActiveLetter){
      $nextActiveLetter.classList.add('active');
    }else{
      $currentLetter.classList.add('active', 'is-last')
      // TODO: gameover si no hay próxima palabra
    }







  }



  function gameOver() {
    console.log("Game Over");
  }
</script>
